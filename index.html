<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Revisi√≥n de Amarros</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #2d3748;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
            margin-top: 1rem;
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
        }

        .checklist-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f7fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }

        .checklist-container::-webkit-scrollbar {
            width: 8px;
        }

        .checklist-container::-webkit-scrollbar-track {
            background: #edf2f7;
            border-radius: 10px;
        }

        .checklist-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .checklist-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .checklist-item {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .checklist-item:hover {
            border-color: #667eea;
        }

        .doc-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .doc-checkboxes {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .checkbox-anulado input[type="checkbox"] {
            accent-color: #fc8181;
        }

        .checkbox-no-utilizado input[type="checkbox"] {
            accent-color: #f6ad55;
        }

        .empty-state {
            text-align: center;
            color: #a0aec0;
            padding: 2rem;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
        }

        .modal-title {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-body {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .modal-body strong {
            color: #2d3748;
        }

        .missing-files {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .missing-files-title {
            color: #c53030;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .missing-files-list {
            color: #742a2a;
            margin-left: 1rem;
        }

        .btn-close {
            background: #e2e8f0;
            color: #2d3748;
            box-shadow: none;
        }

        .btn-close:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üì¶ Sistema de Revisi√≥n de Amarros</h1>
        <p class="subtitle">Control y seguimiento de documentos</p>

        <div class="form-group">
            <button class="btn" type="button" onclick="window.location.href='amarros-pendientes.html'">Ver amarros
                pendientes</button>
        </div>

        <div class="form-group">
            <button class="btn" type="button" onclick="window.location.href='gestionar-amarros.html'"
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Gestionar amarros</button>
        </div>

        <div class="form-group">
            <label for="packageName">Codigo del Amarro</label>
            <input type="text" id="packageName" placeholder="Ej: 07-2016 o 072016">
        </div>

        <div class="form-group">
            <label for="year">A√±o</label>
            <input type="number" id="year" min="1900" max="2100" placeholder="2025">
        </div>

        <div class="form-group">
            <label for="reviewer">Revisor</label>
            <input type="text" id="reviewer" placeholder="Escribe tu nombre">
        </div>

        <div class="range-inputs">
            <div class="form-group">
                <label for="rangeFrom">Desde</label>
                <input type="number" id="rangeFrom" min="1" placeholder="1">
            </div>
            <div class="form-group">
                <label for="rangeTo">Hasta</label>
                <input type="number" id="rangeTo" min="1" placeholder="100">
            </div>
        </div>

        <button class="btn" onclick="generateChecklist()">Generar Lista de Documentos</button>

        <div id="checklistContainer" class="checklist-container hidden">
            <div id="checklistItems"></div>
        </div>

        <button id="addExtraDocBtn" class="btn hidden" onclick="showExtraDocModal()"
            style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); margin-top: 1rem;">‚ûï Agregar documento
            fuera de rango</button>

        <div id="extraDocsContainer" class="hidden" style="margin-top: 1.5rem;">
            <h3 style="color: #2d3748; font-size: 1.1rem; margin-bottom: 0.75rem;">Documentos Adicionales</h3>
            <div id="extraDocsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
        </div>

        <button id="saveBtn" class="btn btn-success hidden" onclick="saveRevision()">Guardar Revisi√≥n</button>
        <button id="nuevoAmarroBtn" class="btn hidden" onclick="window.location.href='index.html'"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 0.5rem;">üîÑ Nuevo
            Amarro</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">‚úì</div>
                <div class="modal-title">Revisi√≥n Guardada</div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <button class="btn btn-close" onclick="closeModal()">Cerrar</button>
        </div>
    </div>

    <!-- Modal para agregar documento fuera de rango -->
    <div id="extraDocModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">üìÑ</div>
                <div class="modal-title">Agregar Documento Fuera de Rango</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="extraDocNumber">N√∫mero de Documento</label>
                    <input type="number" id="extraDocNumber" placeholder="Ej: 999">
                </div>
                <div class="form-group">
                    <label for="extraDocObs">Observaci√≥n</label>
                    <input type="text" id="extraDocObs" placeholder="Motivo o nota sobre este documento">
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="addExtraDocument()">Agregar</button>
                <button class="btn btn-close" onclick="closeExtraDocModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        function generateChecklist() {
            const packageName = document.getElementById('packageName').value.trim();
            const year = parseInt(document.getElementById('year').value);
            const rangeFrom = parseInt(document.getElementById('rangeFrom').value);
            const rangeTo = parseInt(document.getElementById('rangeTo').value);

            // Validaciones
            if (!packageName) {
                alert('Por favor, ingresa el nombre del amarro');
                return;
            }

            if (isNaN(year)) {
                alert('Por favor, ingresa un a√±o v√°lido');
                return;
            }

            if (isNaN(rangeFrom) || isNaN(rangeTo)) {
                alert('Por favor, ingresa valores v√°lidos para el rango');
                return;
            }

            if (rangeFrom > rangeTo) {
                alert('El valor "Desde" debe ser menor o igual que "Hasta"');
                return;
            }

            if (rangeTo - rangeFrom > 1000) {
                alert('El rango no puede ser mayor a 1000 elementos');
                return;
            }

            // Generar checklist
            const container = document.getElementById('checklistContainer');
            const itemsContainer = document.getElementById('checklistItems');
            itemsContainer.innerHTML = '';

            for (let i = rangeFrom; i <= rangeTo; i++) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';

                const header = document.createElement('div');
                header.className = 'doc-header';
                header.textContent = `Documento ${i}`;

                const checkboxesContainer = document.createElement('div');
                checkboxesContainer.className = 'doc-checkboxes';

                // Checkbox 1: Existe f√≠sicamente
                const group1 = document.createElement('div');
                group1.className = 'checkbox-group';
                const checkbox1 = document.createElement('input');
                checkbox1.type = 'checkbox';
                checkbox1.id = `file-${i}`;
                checkbox1.checked = true;
                const label1 = document.createElement('label');
                label1.htmlFor = `file-${i}`;
                label1.textContent = 'Existe f√≠sicamente';
                group1.appendChild(checkbox1);
                group1.appendChild(label1);

                // Checkbox 2: Anulado
                const group2 = document.createElement('div');
                group2.className = 'checkbox-group checkbox-anulado';
                const checkbox2 = document.createElement('input');
                checkbox2.type = 'checkbox';
                checkbox2.id = `anulado-${i}`;
                const label2 = document.createElement('label');
                label2.htmlFor = `anulado-${i}`;
                label2.textContent = 'Anulado';
                group2.appendChild(checkbox2);
                group2.appendChild(label2);

                // Checkbox 3: No utilizado
                const group3 = document.createElement('div');
                group3.className = 'checkbox-group checkbox-no-utilizado';
                const checkbox3 = document.createElement('input');
                checkbox3.type = 'checkbox';
                checkbox3.id = `no-utilizado-${i}`;
                const label3 = document.createElement('label');
                label3.htmlFor = `no-utilizado-${i}`;
                label3.textContent = 'No utilizado';
                group3.appendChild(checkbox3);
                group3.appendChild(label3);

                checkboxesContainer.appendChild(group1);
                checkboxesContainer.appendChild(group2);
                checkboxesContainer.appendChild(group3);

                itemDiv.appendChild(header);
                itemDiv.appendChild(checkboxesContainer);
                itemsContainer.appendChild(itemDiv);
            }

            container.classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('nuevoAmarroBtn').classList.remove('hidden');
            document.getElementById('addExtraDocBtn').classList.remove('hidden');
        }

        function saveRevision() {
            const packageName = document.getElementById('packageName').value.trim();
            const year = parseInt(document.getElementById('year').value);
            const reviewer = document.getElementById('reviewer').value.trim();
            const rangeFrom = parseInt(document.getElementById('rangeFrom').value);
            const rangeTo = parseInt(document.getElementById('rangeTo').value);

            if (isNaN(year)) {
                alert('Por favor, ingresa un a√±o v√°lido');
                return;
            }

            // Encontrar archivos faltantes (checkboxes desmarcados)
            const missingFiles = [];
            const documents = [];
            for (let i = rangeFrom; i <= rangeTo; i++) {
                const checkboxExiste = document.getElementById(`file-${i}`);
                const checkboxAnulado = document.getElementById(`anulado-${i}`);
                const checkboxNoUtilizado = document.getElementById(`no-utilizado-${i}`);

                const exists = checkboxExiste && checkboxExiste.checked ? 1 : 0;

                // Construir observaciones basado en los estados
                let observaciones = [];
                if (checkboxAnulado && checkboxAnulado.checked) {
                    observaciones.push('Anulado');
                }
                if (checkboxNoUtilizado && checkboxNoUtilizado.checked) {
                    observaciones.push('No utilizado');
                }
                const obsText = observaciones.length > 0 ? observaciones.join(', ') : null;

                if (checkboxExiste && !checkboxExiste.checked) {
                    missingFiles.push(i);
                }

                documents.push({
                    numero_documento: i,
                    existe_fisicamente: exists,
                    observaciones: obsText
                });
            }

            // Enviar datos al backend
            const requestBody = {
                codigo_amarro: packageName,
                anio: year,
                revisor: reviewer,
                rango_inicio: rangeFrom,
                rango_fin: rangeTo,
                documentos: documents,
                documentos_adicionales: extraDocuments
            };

            // Si estamos en modo edici√≥n, a√±adir edit_id
            if (window.editAmarroId) {
                requestBody.edit_id = window.editAmarroId;
            }

            fetch('guardar_revision.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
                .then(response => response.json())
                .then(data => {
                    // Construir mensaje
                    let message = `<p><strong>Amarro:</strong> ${packageName}</p>`;
                    message += `<p><strong>A√±o:</strong> ${year}</p>`;
                    message += `<p><strong>Rango:</strong> Desde ${rangeFrom} hasta ${rangeTo}</p>`;
                    message += `<p><strong>Total de documentos:</strong> ${rangeTo - rangeFrom + 1}</p>`;

                    if (missingFiles.length > 0) {
                        message += `<div class="missing-files">`;
                        message += `<div class="missing-files-title">‚ö†Ô∏è Documentos Faltantes (${missingFiles.length})</div>`;
                        message += `<div class="missing-files-list">`;
                        message += missingFiles.map(num => `Documento ${num}`).join(', ');
                        message += `</div></div>`;
                    } else {
                        message += `<p style="color: #48bb78; font-weight: 600;">‚úì Todos los documentos est√°n presentes</p>`;
                    }

                    if (data && data.success) {
                        message += `<p style="margin-top: 1rem; color: #2b6cb0;"><strong>Base de datos:</strong> Revisi√≥n guardada correctamente (ID amarro: ${data.amarro_id}).</p>`;
                    } else {
                        message += `<p style="margin-top: 1rem; color: #c53030;"><strong>Base de datos:</strong> No se pudo guardar la revisi√≥n. ${data && data.message ? data.message : ''}</p>`;
                    }

                    // Mostrar modal
                    document.getElementById('modalBody').innerHTML = message;
                    document.getElementById('modal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error al guardar la revisi√≥n:', error);

                    // Guardar en localStorage como respaldo
                    const revisionData = {
                        codigo_amarro: packageName,
                        anio: year,
                        revisor: reviewer,
                        rango_inicio: rangeFrom,
                        rango_fin: rangeTo,
                        documentos: documents,
                        documentos_adicionales: extraDocuments,
                        timestamp: new Date().toISOString()
                    };

                    let pendingRevisions = JSON.parse(localStorage.getItem('pendingRevisions') || '[]');
                    pendingRevisions.push(revisionData);
                    localStorage.setItem('pendingRevisions', JSON.stringify(pendingRevisions));

                    let message = `<p><strong>Amarro:</strong> ${packageName}</p>`;
                    message += `<p><strong>A√±o:</strong> ${year}</p>`;
                    message += `<p><strong>Rango:</strong> Desde ${rangeFrom} hasta ${rangeTo}</p>`;
                    message += `<p><strong>Total de documentos:</strong> ${rangeTo - rangeFrom + 1}</p>`;

                    if (missingFiles.length > 0) {
                        message += `<div class="missing-files">`;
                        message += `<div class="missing-files-title">‚ö†Ô∏è Documentos Faltantes (${missingFiles.length})</div>`;
                        message += `<div class="missing-files-list">`;
                        message += missingFiles.map(num => `Documento ${num}`).join(', ');
                        message += `</div></div>`;
                    } else {
                        message += `<p style="color: #48bb78; font-weight: 600;">‚úì Todos los documentos est√°n presentes</p>`;
                    }

                    message += `<p style="margin-top: 1rem; color: #f59e0b;"><strong>‚ö†Ô∏è Sin conexi√≥n a base de datos</strong></p>`;
                    message += `<p style="color: #2b6cb0;">‚úì Revisi√≥n guardada localmente (${pendingRevisions.length} pendiente(s))</p>`;

                    document.getElementById('modalBody').innerHTML = message;
                    document.getElementById('modal').style.display = 'flex';

                    updatePendingIndicator();
                });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Manejo de documentos fuera de rango
        let extraDocuments = [];

        function showExtraDocModal() {
            document.getElementById('extraDocModal').style.display = 'flex';
            document.getElementById('extraDocNumber').value = '';
            document.getElementById('extraDocObs').value = '';
        }

        function closeExtraDocModal() {
            document.getElementById('extraDocModal').style.display = 'none';
        }

        function addExtraDocument() {
            const number = parseInt(document.getElementById('extraDocNumber').value);
            const obs = document.getElementById('extraDocObs').value.trim();

            if (isNaN(number)) {
                alert('Por favor, ingresa un n√∫mero de documento v√°lido');
                return;
            }

            // Verificar si ya existe
            const exists = extraDocuments.find(doc => doc.numero_documento === number);
            if (exists) {
                alert('Este documento ya fue agregado');
                return;
            }

            extraDocuments.push({
                numero_documento: number,
                observaciones: obs
            });

            updateExtraDocsList();
            closeExtraDocModal();
        }

        function removeExtraDocument(number) {
            extraDocuments = extraDocuments.filter(doc => doc.numero_documento !== number);
            updateExtraDocsList();
        }

        function updateExtraDocsList() {
            const container = document.getElementById('extraDocsContainer');
            const list = document.getElementById('extraDocsList');

            if (extraDocuments.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = '';

            extraDocuments.forEach(doc => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #fff5e6; border-left: 4px solid #ed8936; padding: 0.75rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';

                const info = document.createElement('div');
                info.innerHTML = `<strong>Documento ${doc.numero_documento}</strong>${doc.observaciones ? ': ' + doc.observaciones : ''}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.style.cssText = 'background: #fc8181; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;';
                deleteBtn.onclick = () => removeExtraDocument(doc.numero_documento);

                item.appendChild(info);
                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        // Cerrar modal de extra doc al hacer clic fuera
        document.getElementById('extraDocModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeExtraDocModal();
            }
        });

        // Funci√≥n para resetear el formulario y empezar nuevo amarro
        function nuevoAmarro() {
            document.getElementById('packageName').value = '';
            document.getElementById('year').value = '';
            document.getElementById('reviewer').value = '';
            document.getElementById('rangeFrom').value = '';
            document.getElementById('rangeTo').value = '';
            document.getElementById('checklistContainer').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('nuevoAmarroBtn').classList.add('hidden');
            document.getElementById('addExtraDocBtn').classList.add('hidden');
            document.getElementById('extraDocsContainer').classList.add('hidden');
            extraDocuments = [];
            alert('‚úì Formulario limpiado. Puedes iniciar un nuevo amarro.');
        }

        // Funci√≥n para actualizar indicador de revisiones pendientes
        function updatePendingIndicator() {
            const pendingRevisions = JSON.parse(localStorage.getItem('pendingRevisions') || '[]');
            let indicator = document.getElementById('pendingIndicator');

            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'pendingIndicator';
                indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f59e0b; color: white; padding: 0.75rem 1.25rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); cursor: pointer; font-weight: 600; z-index: 1000;';
                indicator.onclick = syncPendingRevisions;
                document.body.appendChild(indicator);
            }

            if (pendingRevisions.length > 0) {
                indicator.innerHTML = `üì§ ${pendingRevisions.length} revisi√≥n(es) pendiente(s) - Click para sincronizar`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Funci√≥n para sincronizar revisiones pendientes
        async function syncPendingRevisions() {
            const pendingRevisions = JSON.parse(localStorage.getItem('pendingRevisions') || '[]');

            if (pendingRevisions.length === 0) {
                alert('No hay revisiones pendientes para sincronizar.');
                return;
            }

            if (!confirm(`¬øSincronizar ${pendingRevisions.length} revisi√≥n(es) pendiente(s) con la base de datos?`)) {
                return;
            }

            let successCount = 0;
            let failedRevisions = [];

            for (const revision of pendingRevisions) {
                try {
                    const response = await fetch('guardar_revision.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(revision)
                    });

                    const data = await response.json();

                    if (data && data.success) {
                        successCount++;
                    } else {
                        failedRevisions.push(revision);
                    }
                } catch (error) {
                    console.error('Error sincronizando revisi√≥n:', error);
                    failedRevisions.push(revision);
                }
            }

            // Actualizar localStorage solo con las que fallaron
            localStorage.setItem('pendingRevisions', JSON.stringify(failedRevisions));

            if (successCount > 0) {
                alert(`‚úÖ ${successCount} revisi√≥n(es) sincronizada(s) exitosamente.${failedRevisions.length > 0 ? `\n‚ö†Ô∏è ${failedRevisions.length} revisi√≥n(es) a√∫n pendiente(s).` : ''}`);
            } else {
                alert('‚ùå No se pudo sincronizar ninguna revisi√≥n. Verifica tu conexi√≥n.');
            }

            updatePendingIndicator();
        }

        // Verificar revisiones pendientes al cargar
        document.addEventListener('DOMContentLoaded', () => {
            updatePendingIndicator();
            loadAmarroFromURL(); // Cargar datos si viene de edici√≥n
        });

        // Funci√≥n para cargar datos de amarro desde URL para editar
        async function loadAmarroFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (!params.has('edit_id')) {
                return; // No hay datos para cargar
            }

            // Llenar los campos del formulario
            const codigo = params.get('codigo');
            const anio = params.get('anio');
            const revisor = params.get('revisor');
            const rangoInicio = params.get('rango_inicio');
            const rangoFin = params.get('rango_fin');

            if (codigo) document.getElementById('packageName').value = codigo;
            if (anio) document.getElementById('year').value = anio;
            if (revisor) document.getElementById('reviewer').value = revisor;
            if (rangoInicio) document.getElementById('rangeFrom').value = rangoInicio;
            if (rangoFin) document.getElementById('rangeTo').value = rangoFin;

            // Mostrar mensaje de edici√≥n
            const editId = params.get('edit_id');
            const container = document.querySelector('.container');
            const alert = document.createElement('div');
            alert.style.cssText = 'background: #4299e1; color: white; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: center; font-weight: 600;';
            alert.innerHTML = `‚úèÔ∏è Modo Edici√≥n - Amarro ID: ${editId}<br><small style="font-weight: 400;">Modifica los valores y guarda para actualizar</small>`;
            container.insertBefore(alert, container.firstChild);

            // Guardar el edit_id para usarlo al guardar
            window.editAmarroId = editId;

            // Cargar estados de documentos autom√°ticamente
            if (rangoInicio && rangoFin) {
                try {
                    const response = await fetch(`obtener_documentos_amarro.php?amarro_id=${editId}`);
                    const data = await response.json();

                    if (data && data.success && data.documentos) {
                        // Generar la lista autom√°ticamente con los estados
                        generateChecklistWithStates(parseInt(rangoInicio), parseInt(rangoFin), data.documentos);
                    } else {
                        // Si falla, generar lista normal
                        generateChecklist();
                    }
                } catch (error) {
                    console.error('Error al cargar documentos:', error);
                    // Si falla, generar lista normal
                    generateChecklist();
                }
            }
        }

        // Funci√≥n para generar checklist con estados precargados
        function generateChecklistWithStates(rangeFrom, rangeTo, documentosData) {
            const container = document.getElementById('checklistContainer');
            const itemsContainer = document.getElementById('checklistItems');
            itemsContainer.innerHTML = '';

            // Crear mapa de documentos por n√∫mero
            const docMap = {};
            documentosData.forEach(doc => {
                docMap[doc.numero_documento] = doc;
            });

            for (let i = rangeFrom; i <= rangeTo; i++) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';

                const header = document.createElement('div');
                header.className = 'doc-header';
                header.textContent = `Documento ${i}`;

                const checkboxesContainer = document.createElement('div');
                checkboxesContainer.className = 'doc-checkboxes';

                const docData = docMap[i];
                const existeFisicamente = docData ? docData.existe_fisicamente === 1 : true;
                const observaciones = docData ? (docData.observaciones || '') : '';
                const esAnulado = observaciones.includes('Anulado');
                const esNoUtilizado = observaciones.includes('No utilizado');

                // Checkbox 1: Existe f√≠sicamente
                const group1 = document.createElement('div');
                group1.className = 'checkbox-group';
                const checkbox1 = document.createElement('input');
                checkbox1.type = 'checkbox';
                checkbox1.id = `file-${i}`;
                checkbox1.checked = existeFisicamente;
                const label1 = document.createElement('label');
                label1.htmlFor = `file-${i}`;
                label1.textContent = 'Existe f√≠sicamente';
                group1.appendChild(checkbox1);
                group1.appendChild(label1);

                // Checkbox 2: Anulado
                const group2 = document.createElement('div');
                group2.className = 'checkbox-group checkbox-anulado';
                const checkbox2 = document.createElement('input');
                checkbox2.type = 'checkbox';
                checkbox2.id = `anulado-${i}`;
                checkbox2.checked = esAnulado;
                const label2 = document.createElement('label');
                label2.htmlFor = `anulado-${i}`;
                label2.textContent = 'Anulado';
                group2.appendChild(checkbox2);
                group2.appendChild(label2);

                // Checkbox 3: No utilizado
                const group3 = document.createElement('div');
                group3.className = 'checkbox-group checkbox-no-utilizado';
                const checkbox3 = document.createElement('input');
                checkbox3.type = 'checkbox';
                checkbox3.id = `no-utilizado-${i}`;
                checkbox3.checked = esNoUtilizado;
                const label3 = document.createElement('label');
                label3.htmlFor = `no-utilizado-${i}`;
                label3.textContent = 'No utilizado';
                group3.appendChild(checkbox3);
                group3.appendChild(label3);

                checkboxesContainer.appendChild(group1);
                checkboxesContainer.appendChild(group2);
                checkboxesContainer.appendChild(group3);

                itemDiv.appendChild(header);
                itemDiv.appendChild(checkboxesContainer);
                itemsContainer.appendChild(itemDiv);
            }

            container.classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('nuevoAmarroBtn').classList.remove('hidden');
            document.getElementById('addExtraDocBtn').classList.remove('hidden');
        }
    </script>
</body>

</html>